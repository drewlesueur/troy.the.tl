<!doctype html>
<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Josefin+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet/less" type="text/css" href="styles.less">
<style>
  body {
    /*background-color: rgb(39,39,39);
    background-image: -webkit-gradient(radial, 500 25%, 20, 500 25%, 40, from(#000), to(rgb(39,39,39)));
    */
    

  }  
</style>
<script src="http://inc.the.tl/less.js" type="text/javascript"></script>
<script src="http://inc.the.tl/jquery.js"></script>

<script>
  webkit = navigator.userAgent.match(/WebKit/)
  if (webkit) {
    document.write('<script src="http://inc.the.tl/zepto/src/zepto.js"><\/script>')
    document.write('<script src="http://inc.the.tl/zepto/src/event.js"><\/script>')
    document.write('<script src="http://inc.the.tl/zepto/src/fx.js"><\/script>')
    document.write('<script src="http://inc.the.tl/zepto/src/detect.js"><\/script>')
  }
</script>
<script>
  if (!webkit) {
    z = function(){}
    z.browser = {"webkit": false}
  } else {
    z = Zepto
  }

  $ = jQuery

</script>

<script src="http://inc.the.tl/jqueryui.js"></script>
<script src="http://inc.the.tl/underscore.js"></script>
<script src="http://inc.the.tl/coffeescript.js"></script>
<script src="http://inc.the.tl/k/index.js"></script>

<script type="text/coffeescript">
  div = (str) ->
    return $ "<div>#{str}</div>"
  getEl = (obj) ->
    if _.isString obj
      return $ obj
    else if obj instanceof jQuery or obj instanceof Zepto or _.isElement obj
      return obj
    else 
      return obj && obj.el
      
  #problem. instantiating should NOT append to the dom or the object
  if !window.console
    window.console = {}
  if !window.console.log
    window.console.log = () ->
  $(document).ready () ->

    #trying the Model View Presenter pattern

    #this is a rusty model... polish it. look to backbone as an example
    HomeModel = k.class
      initialize: (e) ->
      loadGalleries: (e) ->
        $.ajax
          type: "GET"
          url: "http://troybrinkerhoff.com/new2/galleries.php"
          dataType: "jsonp"
          success: (data) ->
            k(e).set "galleries": data 
            
    ImagePanelView = k.class
      initialize: (e) ->
        e.el = div ""
      addImage: (e, url, css, meta) ->
        img = $ document.createElement "img"
        img.attr "src", url
        img.css css
        e.el.append img
        img.bind "click", (event) ->
          k(e).trigger "click", meta


    HomePresenter = k.class
      initialize: (e) ->
        e.model = k.new HomeModel
        model = e.model
        e.view = k.new HomeView
        view = e.view

        k(model).bind "change:galleries", (e) ->
          p(view).clearNavLinks()
          for gallery, info of model.galleries
            p(view).addNavLink k.capitalize(k(gallery).s("gallery_".length)), "#"
            

        
        k(view).bind "link", (e, linkName) ->
          if linkName is view.galleryState
            return
          view.galleryState = linkName
          p.clearThumbnails e
          p.slideThumbnails e, "out"
          p.slideBanner e, "down"
          gallery_name = "gallery_" + linkName.toLowerCase() 
          for image, index in model.galleries[gallery_name].images
            if k.s(image, -2) == "db" then return
            url = 
              big: image
              thumb: model.galleries[gallery_name].thumbs[index]
            p.addImage view, url 


        k(view).bind "homeclick", (e) ->
          view.galleryState = ""
          p.slideThumbnails e, "in"
          p.slideBanner e, "up"
          

        p(model).loadGalleries()

   

    HorizontalSliderView = k.class
      initialize: (e, width, height) ->
        e.el = $ "<div>"
        e.width = width or "300"
        e.height = height or "500"
        e.el.css
          "width": "#{e.width}px"
          "height": "#{e.height}px"
          "background-color" : "rgb(70,70,70)"
          "position" : "absolute"
          "top" : "0"
          e.slideWrapper = div ""
          e.slideWrapper.css "position": "absolute"
          e.el.append e.slideWrapper
          e.pannelCount = 0
        return e 
      goto : (e, index) ->
        if z.browser.webkit
          translateX =  (-1 * (index * e.width)) 
          z(e.slideWrapper[0]).anim "translateX" : translateX + "px"
        else
          $(e.slideWrapper).animate "left" : (-1 * (index * e.width)) + "px"
        
      addPannel: (e, pannelView) ->
        e.pannelCount++
        count = e.pannelCount # so count has its own scope
        if not pannelView
          pannelView = $ "<div>"
        pannelEl = getEl pannelView
        pannelWrapper = $ "<div>"
        pannelWrapper.css 
          "width": "#{e.width}px"
          "height": "#{e.height}px"
          "position": "absolute"
          "top" : "0"
          "left": (e.pannelCount - 1) * e.width 
        pannelWrapper.append pannelEl
        pannelWrapper.bind "click", (event) ->
          k(e).trigger "click", count - 1

        $(e.slideWrapper).css "width": (e.pannelCount * e.width) + "px"
        e.slideWrapper.append getEl pannelWrapper 

    HomeView = k.class
      #jquert binds and triggers can go in here
      initialize: (e) ->
        e.thumbsWidth = 200
        e.el = $('#home-wrapper')
        e.state = "home"
        e.thumbGroupings = []
        $('#main-logo').click (event) ->
          k(e).trigger "homeclick"
        e.thumbsView = k.new HorizontalSliderView, e.thumbsWidth, 640
          
        console.log e.thumbsView.el
        $('#thumbs').append e.thumbsView.el
      clearNavLinks: (e) ->
        e.el.find("#links").empty()
      addNavLink: (e, linkName, linkAddress) ->
        a = $ "<a href='#'>#{linkName}</a>"
        a.bind "click", (event) ->
          event.preventDefault();
          k(e).trigger "link", linkName
          
        e.el.find("#links").append a
      loadViewerImage: (e, url) ->
        $("#viewer-img").attr "src", url
      addThumbGrouping: (name, urls) ->
        $("#thumbs")
      addImage: (e, urls) ->
        return
        thumb = $("<img class='thumb' >")
        thumb.attr "src", urls.thumb
        thumb.bind "click", (event) ->
          p.loadViewerImage e, urls.big
          k(e).trigger "imageSelected", urls, thumb
        $("#thumbs").append thumb
      clearThumbnails: (e) ->
        return
        $("#thumbs").empty()
      slideThumbnails: (e, outOrIn) ->
        if outOrIn == "out"
          translate = "-#{e.thumbsWidth}px"
          right = 0
        else
          translate = 0
          right = "-#{e.thumbsWidth}px"
        if z.browser.webkit
          z("#thumbs").anim({"translateX": translate})
        else
          $('#thumbs').animate({right: right})
      slideBanner: (e, upOrDown) ->
        if upOrDown is "down"
          translate = "50px"
          bottom = 0
        else
          translate = 0
          bottom = "50px"
        if z.browser.webkit
          z("#banner").anim "translateY" : translate
        else
          $("#banner").animate "bottom" : bottom

    home = k.new HomePresenter
    
    return


    
</script>
</head>
<body>
  <div id="wrapper" align="center">
    <div id="home-wrapper">
      <div id="home-image"></div>
      <div id="viewer"><img id="viewer-img" src="blank.gif" /></div>
      <div id="slide"></div>
      <div id="thumbs"></div>

      <div id="banner">
        <span id="main-logo">Troy Brinkerhoff</span>
        <div id="links">
        </div>
      </div>  
    </div>
  </div>
</body>
</html>
